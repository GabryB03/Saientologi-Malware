using System;
using System.Drawing.Imaging;
using System.Drawing;
using System.IO;
using System.Runtime.InteropServices;
using System.Text;
using System.Windows.Forms;

public partial class SaientologiLoaderForm : Form
{
    [DllImport("winmm.dll")]
    private static extern uint mciSendString(string lpstrCommand, StringBuilder lpstrReturnString, int uReturnLength, IntPtr hWndCallback);

    private float _currentOpacity = 0.0F;
    private Image _originalImage = null;

    public SaientologiLoaderForm()
    {
        InitializeComponent();
        string rootDir = Environment.GetFolderPath(Environment.SpecialFolder.System).Substring(0, 1) + ":";
        File.WriteAllBytes($"{rootDir}\\ave_maria.mp3", Saientologi.Properties.Resources.ave_maria);
        mciSendString($"open \"{rootDir}\\ave_maria.mp3\" alias ave_maria", null, 0, IntPtr.Zero);
        mciSendString("play ave_maria", null, 0, IntPtr.Zero);
        _originalImage = pictureBox1.BackgroundImage;
        pictureBox1.BackgroundImage = SetImageOpacity(_originalImage, _currentOpacity);
        timer1.Start();
    }

    private void SaientologiLoaderForm_FormClosing(object sender, FormClosingEventArgs e)
    {
        e.Cancel = true;
    }

    private void button1_Click(object sender, EventArgs e)
    {
        Environment.Exit(0);
    }

    public Image SetImageOpacity(Image image, float opacity)
    {
        try
        {
            Bitmap bmp = new Bitmap(image.Width, image.Height);

            using (Graphics gfx = Graphics.FromImage(bmp))
            {
                ColorMatrix matrix = new ColorMatrix();
                matrix.Matrix33 = opacity;
                ImageAttributes attributes = new ImageAttributes();
                attributes.SetColorMatrix(matrix, ColorMatrixFlag.Default, ColorAdjustType.Bitmap);
                gfx.DrawImage(image, new Rectangle(0, 0, bmp.Width, bmp.Height), 0, 0, image.Width, image.Height, GraphicsUnit.Pixel, attributes);
            }

            return bmp;
        }
        catch
        {
            return null;
        }
    }

    private void timer1_Tick(object sender, EventArgs e)
    {
        if (_currentOpacity >= 1.0F)
        {
            timer1.Stop();

            mciSendString("stop ave_maria", null, 0, IntPtr.Zero);
            mciSendString("close ave_maria", null, 0, IntPtr.Zero);

            TopMost = false;
            Opacity = 0;
            Size = new Size(0, 0);
            Visible = false;
            WindowState = FormWindowState.Minimized;
            Hide();

            new JumpscareForm().Show();
        }
        else
        {
            _currentOpacity += 0.01F;
            pictureBox1.BackgroundImage = SetImageOpacity(_originalImage, _currentOpacity);
        }
    }
}